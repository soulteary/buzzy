<% @page_title = t("users.edit.page_title") %>

<% content_for :header do %>
  <div class="header__actions header__actions--start">
    <%= back_link_to t("users.edit.back_to"), profile_user_path(@user, script_name: nil), "keydown.left@document->hotkey#click keydown.esc@document->hotkey#click" %>
  </div>
<% end %>

<div class="panel shadow center" style="--panel-size: 45ch;">
  <div class="flex flex-column gap txt-medium">
    <%= form_with model: @user, method: :patch, class: "flex flex-column gap", data: { controller: "form upload-preview" } do |form| %>
      <div class="align-center center avatar__form gap">
        <span class="btn btn--placeholder txt-small"></span>

        <label class="avatar btn btn--circle input--file txt-xx-large center fill-white">
          <%= image_tag user_avatar_path(@user, script_name: nil), aria: { hidden: "true" }, class: "avatar", size: 128, data: { upload_preview_target: "image" } %>
          <%= form.file_field :avatar, id: "file", class: "input", accept: User::Avatar::ALLOWED_AVATAR_CONTENT_TYPES.join(","),
                data: { upload_preview_target: "input", action: "upload-preview#previewImage" } %>
          <span class="for-screen-reader"><%= t("users.edit.profile_avatar_for", name: @user.name) %></span>
        </label>

        <% if @user.avatar.attached? %>
          <%= tag.button type: :submit, form: "avatar-delete-form", class: "btn btn--negative txt-small", data: { turbo_confirm: t("users.edit.remove_avatar_confirm") } do %>
            <%= icon_tag "minus" %>
            <span class="for-screen-reader"><%= t("users.edit.delete_avatar") %></span>
          <% end %>
        <% end %>
      </div>

      <div class="flex align-center gap">
        <label class="flex align-center gap input input--actor">
          <%= form.text_field :name, class: "input full-width", autocomplete: "off", placeholder: t("users.edit.name_placeholder"), autofocus: true, required: true, data: { "1p-ignore": true, action: "keydown.esc@document->form#cancel" } %>
        </label>
      </div>

      <div class="flex flex-column gap-half">
        <label class="txt-small" for="user_bio"><%= t("users.edit.bio_label") %></label>
        <%= form.text_area :bio, id: "user_bio", class: "input full-width", rows: 4, maxlength: 140, placeholder: t("users.edit.bio_placeholder"), data: { action: "keydown.esc@document->form#cancel" } %>
        <p class="txt-x-small txt-tinted margin-block-none"><%= t("users.edit.bio_hint") %></p>
      </div>

      <% if show_email_in_ui? %>
        <div class="flex align-center gap">
          <div class="flex align-center gap input input--actor">
            <%= form.email_field :email_address, class: "input full-width", autocomplete: "username", placeholder: t("users.edit.email_address"), required: true, readonly: true, value: @user.identity.email_address %>
            <% unless @user.identity.respond_to?(:email_locked?) && @user.identity.email_locked? %>
              <%= link_to t("users.edit.change_email"), new_user_email_address_path(user_id: Current.user.id, script_name: nil), class: "btn btn--plain txt-link txt-small txt-nowrap" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @user.errors.any? %>
        <div class="margin-block-half txt-negative txt-small" style="text-align: left;">
          <p class="margin-block-none font-weight-bold"><%= t("users.edit.validation_errors") %></p>
          <ul class="margin-block-none">
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <button type="submit" id="log_in" class="btn btn--reversed center" data-form-target="submit">
        <span><%= t("users.edit.save_changes") %></span>
      </button>

      <%= link_to t("shared.cancel_and_go_back"), profile_user_path(@user, script_name: nil), data: { form_target: "cancel", turbo_frame: "_top" }, hidden: true %>
    <% end %>

    <%= form_with url: user_avatar_url(@user, script_name: nil), method: :delete, id: "avatar-delete-form" %>
  </div>
</div>
