#!/usr/bin/env bash
# 克隆 basecamp/lexxy 到 vendor/lexxy，应用 prompt 空格键修复补丁并构建。
# 用于修复：空查询时按空格不应触发 prompt 选项选择（应交给编辑器处理，如 Markdown 标题）。
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUZZY_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
VENDOR_LEXXY="$BUZZY_ROOT/vendor/lexxy"
PATCH_FILE="$BUZZY_ROOT/patches/lexxy-prompt-space-key.patch"

if [[ ! -f "$PATCH_FILE" ]]; then
  echo "错误: 补丁文件不存在: $PATCH_FILE"
  exit 1
fi

if [[ ! -d "$VENDOR_LEXXY" ]]; then
  echo "正在克隆 basecamp/lexxy 到 $VENDOR_LEXXY ..."
  git clone --depth 1 https://github.com/basecamp/lexxy.git "$VENDOR_LEXXY"
fi

cd "$VENDOR_LEXXY"

echo "正在应用补丁: lexxy-prompt-space-key.patch"
if ! patch -p1 --forward < "$PATCH_FILE" 2>/dev/null; then
  echo "补丁可能已应用过或与当前 lexxy 版本不完全匹配，继续构建..."
fi

if ! command -v yarn &> /dev/null && ! command -v npm &> /dev/null; then
  echo "错误: 未找到 yarn 或 npm，请先安装 Node.js 与 yarn。"
  exit 1
fi

echo "安装依赖并构建 lexxy..."
if command -v yarn &> /dev/null; then
  yarn install
  yarn build
else
  npm install
  npm run build
fi

echo ""
echo "lexxy 已就绪。请执行: bundle install"
echo "Gemfile 中已配置为使用 vendor/lexxy。"
