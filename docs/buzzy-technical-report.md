# Buzzy 技术报告

本文面向 `buzzy/` 当前实现，聚焦系统定位、关键架构、能力边界、主要风险与演进建议。

## 1. 系统定位

- Buzzy 基于 Fizzy 演进，但已不再是简单的“改名分叉”。
- 工程目标偏向：
  - 私有化部署可控
  - 统一网关身份接入
  - 功能策略可收敛（按实例需要启用/禁用）

## 2. 架构总览

### 2.1 认证与身份

- 保留原有 session/bearer 能力。
- 新增 Forward Auth 机制：
  - 通过 `X-Auth-Email` 等 Header 接收网关身份。
  - 仅在 trusted 条件满足时生效（trusted IP 与/或 secret header）。
  - 配置入口：`config/initializers/forward_auth.rb`
  - 核心逻辑：`lib/forward_auth/config.rb`、`app/controllers/concerns/authentication.rb`

### 2.2 多租户寻址

- 采用 URL 路径前缀多租户模型。
- Buzzy 将路径租户标识切换为 UUID 前缀，替代上游数字外部 ID 前缀。
- 相关中间件：`config/initializers/tenanting/account_slug.rb`

### 2.3 权限与可见性

- 在上游权限模型基础上，补充了更细粒度的可见性与可编辑性语义：
  - 同账号访问
  - 跨账号受限访问
  - 提及/公开回落路径
  - super admin 特殊能力
- 关键落点：`ApplicationController`、`UsersController`、策略类与相关 helper。

### 2.4 功能策略开关

- 全局开关集中在 `lib/buzzy.rb`：
  - `DISABLE_SESSION_TRANSFER`
  - `DISABLE_EXPORT_DATA`
  - `HIDE_EMAILS`
  - `ADMIN_EMAILS`
- 特点：通过环境变量控制实例行为，适配不同部署策略。

## 3. 核心能力清单

### 3.1 Forward Auth 集成能力

- 可与 Traefik/Stargate 等网关形成统一登录链路。
- 支持自动 provisioning、自动创建会话、自动创建账号（可配置）。
- 具备独立文档与测试保障：
  - `docs/forward_auth.md`
  - `test/lib/forward_auth/config_test.rb`

### 3.2 管理与运营能力扩展

- 增加 `square/*` 与扩展 `admin/*` 路由域。
- 新增内容聚合能力，以及用户侧看板/卡片入口等访问路径。
- 在 UI 侧配合隐藏邮箱、受限编辑等策略控制。

### 3.3 部署与运行指引增强

- 提供更贴近生产代理链路的配置示例（Compose、网关、manifest 访问策略）。
- 提供常见故障场景（401、重定向循环、数据库授权等）的排障说明。

### 3.4 工程可维护性改进

- 持续推进依赖升级，降低老旧依赖带来的安全与兼容风险。
- 对依赖组织进行收敛与简化，减少重复能力与历史兼容分支导致的维护负担。
- 围绕分叉关键能力补齐测试覆盖，使认证、路由与权限等高风险路径具备更稳定的回归基础。

## 4. 工程质量观察

- 变更覆盖核心层：`app/`、`config/`、`test/`、`db/`。
- 测试同步跟进（含多类新增与改动），但控制器复杂度明显上升，长期维护压力主要集中在认证与权限分支。

## 5. 主要技术风险

### 5.1 网关配置耦合风险

- Forward Auth 正确性依赖代理请求头与信任链配置。
- 配置错误通常会直接表现为登录失败、401 或循环跳转。

### 5.2 权限逻辑分支风险

- 同账号/跨账号/提及回落/公开回落/super admin 等分支叠加，回归覆盖面显著扩大。
- 需要持续维护覆盖矩阵，否则易出现边界行为回退。

### 5.3 上游同步风险

- 与 Fizzy 的公共路径差异较大，且核心文件改动深。
- 后续上游更新引入冲突概率高，同步成本长期存在。

### 5.4 链接与迁移兼容风险

- 租户 slug 规则变化会影响历史链接、外部系统回调以及脚本依赖。
- 迁移准备不足时，可能出现路径不可达或 404。

## 6. 技术债与改进建议

### 6.1 认证与权限治理

- 将复杂布尔判断逐步下沉到 policy/service，降低控制器认知负担。
- 为跨账号与 fallback 路径建立独立规范文档与约束测试。

### 6.2 回归测试矩阵

- 建议建立固定矩阵：
  - Forward Auth 开/关
  - trusted/untrusted
  - 单账号/多账号
  - 同账号/跨账号访问
  - Turbo Frame 页面与全页访问

### 6.3 运维可观测性

- 统一关键认证日志字段，并建立告警规则（trusted 失败、Header 缺失、重定向异常）。
- 为网关到应用链路增加自检脚本，降低部署后的排障成本。

### 6.4 上游差异管理

- 维护“差异账本”（模块级，含原因与替代方案），作为未来 rebase 或择优回移的依据。
- 定期评估是否将通用改进回馈上游，降低长期分叉负担。

### 6.5 依赖与测试持续治理

- 依赖升级采用“分批、小步、可回滚”的节奏，避免一次性跨越带来的大规模回归风险。
- 定期清理低价值或重复依赖，优先复用框架内建能力，保持依赖树可解释、可维护。
- 将新增测试覆盖纳入发布前门禁，重点保障 Forward Auth、租户前缀与跨账号访问等高变更面。

## 7. 结论

- Buzzy 当前技术形态可定义为“以可控性和私有化部署为优先”的业务分支。
- 该路线在统一认证、策略治理、运维落地方面收益明确，但代价是更高的复杂度与上游同步成本。
- 若要保持后续可持续演进，关键在于：权限逻辑收敛、测试矩阵制度化、差异管理工程化。
